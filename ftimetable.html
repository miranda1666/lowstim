<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Timetable</title>
  <style>
    :root{
      /* Core theme tokens (edited via Theme popover) */
      --bg: #ffffff;                 /* full page background */
      --panel: rgba(255,255,255,.65);
      --panel2: rgba(255,255,255,.82);
      --text: #2b2b2b;               /* main text */
      --muted: #6f6a63;              /* secondary text */
      --line: rgba(43,43,43,.12);    /* borders/dividers */
      --gridLine: rgba(43,43,43,.08);
      --focus: rgba(43,43,43,.18);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --shadow2: 0 16px 50px rgba(0,0,0,.14);
      --radius: 18px;
      --radius2: 14px;
      --inkSoft: rgba(43,43,43,.60);

      /* Widget-board background (behind controls + panel) */
      --board-tint: #efe7e1;
      --board-tint-a: 0.35;
      --board-image: none;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 18px 40px;
    }

    /* Header */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .title{
      display:grid;
      gap: 6px;
      min-width: 280px;
    }
    .title h1{
      font-size: clamp(22px, 2.6vw, 32px);
      line-height: 1.1;
      margin: 0;
      letter-spacing: -.02em;
    }
    .title p{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 62ch;
      line-height: 1.4;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.68));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.08); border-color: rgba(43,43,43,.18); }
    .btn:active{ transform: translateY(0px); }
    .btn:focus-visible{ outline: 3px solid var(--focus); outline-offset: 2px; }
    .btn.primary{ border-color: rgba(43,43,43,.14); }
    .btn.danger{ border-color: rgba(160, 60, 60, .20); }

    /* Discreet popovers */
    .popover{ position: relative; }

    .bgBtn{
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.68));
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .bgBtn:active{ transform: translateY(1px); }

    .bgDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,43,.14);
      background: var(--board-tint);
      box-shadow: 0 0 0 6px rgba(239,231,225,0.35);
    }

    .themeDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,43,.14);
      background: var(--text);
      box-shadow: 0 0 0 6px rgba(43,43,43,0.08);
      opacity: .9;
    }

    .panel{
      position: absolute;
      top: 50px;
      right: 0;
      width: 300px;
      border-radius: 16px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px;
      display:none;
      z-index: 60;

      /* ✅ never cut off */
      max-height: min(70vh, 560px);
      overflow:auto;
    }
    .panel.open{ display:block; }
    .panel h3{
      margin: 0 0 10px 0;
      font-size: 13px;
      font-weight: 650;
      color: rgba(43,43,43,.85);
    }
    .pRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 0;
    }
    .pRow label{
      font-size: 12px;
      color: var(--muted);
      padding-left: 0;
    }
    input[type="color"].pColor{
      width: 34px;
      height: 26px;
      border: 1px solid rgba(43,43,43,.14);
      border-radius: 10px;
      padding: 0;
      background: transparent;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    input[type="range"].pRange{ width: 150px; }
    .pFile{
      width: 100%;
      font-size: 12px;
      color: rgba(43,43,43,.75);
    }
    .miniBtn{
      width: 100%;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 9px 10px;
      cursor: pointer;
      font-weight: 650;
      color: rgba(43,43,43,.85);
      -webkit-tap-highlight-color: transparent;
    }
    .miniBtn:active{ transform: translateY(1px); }
    .pDiv{
      height: 1px;
      background: rgba(43,43,43,.08);
      margin: 8px 0;
    }

    /* ✅ Presets UI */
    .presetName{
      width:100%;
      border:1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.95);
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      color: var(--text);
      outline:none;
    }
    .presetSelect{
      width:100%;
      border:1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.95);
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      color: var(--text);
      outline:none;
      height:38px;
    }
    .presetArea{
      width:100%;
      min-height: 92px;
      resize: vertical;
      border:1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.95);
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      line-height:1.35;
      color: var(--text);
      outline:none;
    }
    .status{
      font-size:12px;
      color: var(--muted);
      margin-top: 6px;
      min-height: 16px;
    }

    /* Widget board (ONLY behind controls + panel) */
    .widgetBoard{
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
    }
    .widgetBoard::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--board-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(.95);
      transform: scale(1.02);
      pointer-events:none;
    }
    .widgetBoard::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 520px at 18% 20%, rgba(255,255,255,0.35), transparent 62%),
        radial-gradient(700px 460px at 82% 34%, rgba(255,255,255,0.25), transparent 62%),
        rgba(255,255,255,0.38);
      background-blend-mode: screen;
      pointer-events:none;
    }
    .boardTint{
      position:absolute;
      inset:0;
      pointer-events:none;
      mix-blend-mode: multiply;
      background: rgba(239,231,225,.35); /* set by JS */
    }
    .boardContent{
      position: relative;
      z-index: 2;
    }

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns: 1.1fr .7fr .6fr .6fr;
      gap: 10px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      align-items: end;
    }

    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 620px){
      .controls{ grid-template-columns: 1fr; }
      .actions{ width:100%; justify-content:flex-start; }
    }

    .field{ position: relative; display:grid; gap: 6px; }
    label{ font-size: 12px; color: var(--muted); padding-left: 6px; }
    .input, select{
      width:100%;
      padding: 12px 12px 12px 40px;
      border-radius: 14px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.75);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
      font-size: 14px;
      color: var(--text);
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    select{ padding-left: 12px; }
    .input:focus, select:focus{
      border-color: rgba(43,43,43,.22);
      box-shadow: 0 0 0 3px rgba(43,43,43,.10);
    }
    .icon{
      position:absolute;
      left: 12px;
      top: 36px;
      width: 16px;
      height: 16px;
      opacity: .65;
      pointer-events:none;
    }

    /* Panel */
    .ttPanel{
      margin-top: 16px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow: hidden;
    }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(43,43,43,.08);
      flex-wrap: wrap;
    }
    .meta{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .pill{
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.65);
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
    }

    /* Timetable */
    .gridWrap{ padding: 14px; }
    .timetable{
      width: 100%;
      border-radius: var(--radius2);
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.62);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
      overflow: hidden;
    }

    .ttHeader{
      display:grid;
      grid-template-columns: 78px repeat(7, minmax(0, 1fr));
      gap: 0;
      border-bottom: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.72);
    }
    .ttHeader div{
      padding: 10px 10px;
      font-size: 12px;
      color: var(--muted);
      border-right: 1px solid rgba(43,43,43,.08);
    }
    .ttHeader div:last-child{ border-right: none; }
    .ttHeader .corner{ color: rgba(43,43,43,.55); }
    .dayName{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      font-weight: 650;
      color: rgba(43,43,43,.78);
      letter-spacing: -.01em;
    }

    .ttBody{
      position: relative;
      height: 720px;
      display:grid;
      grid-template-columns: 78px repeat(7, minmax(0, 1fr));
    }

    .timeCol{
      border-right: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.62);
      position: relative;
    }
    .timeLabel{
      position: absolute;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      padding: 0 10px;
      font-size: 11px;
      color: rgba(43,43,43,.62);
      text-align: right;
      pointer-events:none;
    }

    .dayCol{
      position: relative;
      border-right: 1px solid rgba(43,43,43,.08);
      background: rgba(255,255,255,.55);
    }
    .dayCol:last-child{ border-right: none; }

    .hLine{
      position:absolute;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gridLine);
      opacity: .9;
      pointer-events:none;
    }
    .hLine.major{ background: rgba(43,43,43,.10); }

    .event{
      position:absolute;
      left: 8px;
      right: 8px;
      border-radius: 14px;
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.72);
      box-shadow:
        0 10px 22px rgba(0,0,0,.06),
        inset 0 1px 0 rgba(255,255,255,.88);
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      overflow: hidden;
    }
    .event:hover{
      transform: translateY(-1px);
      box-shadow:
        0 14px 30px rgba(0,0,0,.09),
        inset 0 1px 0 rgba(255,255,255,.90);
      border-color: rgba(43,43,43,.16);
    }
    .event:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 3px;
    }
    .eventTitle{
      font-weight: 750;
      font-size: 12.5px;
      letter-spacing: -.01em;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .eventMeta{
      font-size: 11.5px;
      color: rgba(43,43,43,.62);
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .tinyPill{
      font-size: 11px;
      color: rgba(43,43,43,.76);
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.60);
      padding: 3px 8px;
      border-radius: 999px;
    }
    .eventNotes{
      font-size: 11.5px;
      color: rgba(43,43,43,.68);
      line-height: 1.35;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .nowLine{
      position:absolute;
      left: 0;
      right: 0;
      height: 1px;
      background: rgba(43,43,43,.22);
      opacity: .8;
      pointer-events:none;
    }
    .nowDot{
      position:absolute;
      left: 78px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(43,43,43,.72);
      transform: translate(-50%, -50%);
      opacity: .85;
      pointer-events:none;
    }

    .empty{
      padding: 44px 18px 50px;
      display:grid;
      place-items:center;
      text-align:center;
      gap: 12px;
      color: var(--muted);
    }
    .empty .big{
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.7);
      display:grid;
      place-items:center;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 12px 30px rgba(0,0,0,.06);
      font-size: 22px;
    }
    .empty h2{ margin:0; color: var(--text); font-size: 16px; letter-spacing: -.01em; }
    .empty p{ margin:0; max-width: 60ch; font-size: 13.5px; line-height: 1.5; }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      padding: 18px;
      background: rgba(20,18,16,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 50;
    }
    .modalBackdrop.show{ display: grid; }

    .modal{
      width: min(820px, 100%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(43,43,43,.14);
      border-radius: 20px;
      box-shadow: var(--shadow2);
      overflow: hidden;
    }
    .modalHead{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.72);
    }
    .modalHead h3{ margin:0; font-size: 15px; letter-spacing: -.01em; }
    .modalBody{
      padding: 14px 16px 16px;
      display:grid;
      gap: 12px;
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 760px){ .formGrid{ grid-template-columns: 1fr; } }

    .input2, .textarea, .select2{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.78);
      font-size: 14px;
      color: var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    .textarea{ min-height: 88px; resize: vertical; }
    .input2:focus, .textarea:focus, .select2:focus{
      border-color: rgba(43,43,43,.22);
      box-shadow: 0 0 0 3px rgba(43,43,43,.10);
    }

    .modalFoot{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px 16px 14px;
      border-top: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.70);
      flex-wrap: wrap;
    }

    .colorRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .colorInput{
      width: 44px;
      height: 38px;
      padding: 0;
      border-radius: 12px;
      border: 1px solid rgba(43,43,43,.14);
      background: rgba(255,255,255,.75);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Timetable</h1>
      </div>

      <div class="actions">
        <button class="btn primary" id="addBtn" type="button"><span aria-hidden="true">＋</span> Add block</button>
        <button class="btn" id="exportBtn" type="button"><span aria-hidden="true">⤓</span> Export</button>
        <button class="btn danger" id="clearBtn" type="button"><span aria-hidden="true">✕</span> Clear</button>

        <!-- Theme popover (upgraded: draft/apply + presets) -->
        <div class="popover" id="themePopover">
          <button class="bgBtn" id="themeBtn" type="button" aria-label="Theme settings" title="Theme settings">
            <span class="themeDot" id="themeDot" aria-hidden="true"></span>
          </button>

          <div class="panel" id="themePanel" role="dialog" aria-label="Theme settings">
            <h3>Theme</h3>

            <div class="pRow">
              <label for="themeBg">Page background</label>
              <input class="pColor" id="themeBg" type="color" value="#ffffff" />
            </div>

            <div class="pRow">
              <label for="themeText">Text</label>
              <input class="pColor" id="themeText" type="color" value="#2b2b2b" />
            </div>

            <div class="pRow">
              <label for="themeMuted">Muted text</label>
              <input class="pColor" id="themeMuted" type="color" value="#6f6a63" />
            </div>

            <div class="pRow">
              <label for="themeBorders">Border/base color</label>
              <input class="pColor" id="themeBorders" type="color" value="#2b2b2b" />
            </div>

            <div class="pRow">
              <label for="themeBorderAlpha">Border strength</label>
              <input class="pRange" id="themeBorderAlpha" type="range" min="4" max="40" value="12" />
            </div>

            <div class="pRow">
              <label for="themeGridAlpha">Grid strength</label>
              <input class="pRange" id="themeGridAlpha" type="range" min="3" max="30" value="8" />
            </div>

            <div class="pRow">
              <label for="themePanelAlpha">Panel transparency</label>
              <input class="pRange" id="themePanelAlpha" type="range" min="40" max="95" value="65" />
            </div>

            <div class="pDiv"></div>

            <!-- ✅ Apply / Reset -->
            <button class="miniBtn" id="themeApply" type="button">Apply theme</button>
            <button class="miniBtn" id="resetTheme" type="button" style="margin-top:8px;">Reset theme</button>

            <div class="pDiv"></div>

            <!-- ✅ Presets (GLOBAL JSON shared across widgets) -->
            <h3 style="margin:0 0 10px 0; font-size:12px; letter-spacing:.08em; text-transform:uppercase; opacity:.85;">Presets</h3>

            <input class="presetName" id="presetName" placeholder="Preset name">

            <button class="miniBtn" id="presetSave" type="button" style="margin-top:8px;">Save current as preset</button>

            <div class="pDiv"></div>

            <select class="presetSelect" id="presetSelect"></select>

            <button class="miniBtn" id="presetApply" type="button" style="margin-top:8px;">Apply preset</button>
            <button class="miniBtn" id="presetDelete" type="button" style="margin-top:8px;">Delete preset</button>

            <div class="pDiv"></div>

            <button class="miniBtn" id="presetCopy" type="button">Copy preset JSON</button>

            <div class="pDiv"></div>

            <textarea class="presetArea" id="presetImport" placeholder='Paste preset JSON here, then click "Import presets".'></textarea>
            <button class="miniBtn" id="presetImportBtn" type="button" style="margin-top:8px;">Import presets</button>

            <div class="status" id="presetStatus" aria-live="polite"></div>
          </div>
        </div>

        <!-- Background popover (upgraded: draft/apply + reset) -->
        <div class="popover" id="bgPopover">
          <button class="bgBtn" id="bgBtn" type="button" aria-label="Background settings" title="Background settings">
            <span class="bgDot" id="bgDot" aria-hidden="true"></span>
          </button>

          <div class="panel" id="bgPanel" role="dialog" aria-label="Background settings">
            <h3>Background</h3>

            <div class="pRow">
              <label for="bgColor">Tint</label>
              <input class="pColor" id="bgColor" type="color" value="#efe7e1" />
            </div>

            <div class="pRow">
              <label for="bgStrength">Tint strength</label>
              <input class="pRange" id="bgStrength" type="range" min="0" max="70" value="35" />
            </div>

            <div class="pDiv"></div>

            <div class="pRow" style="align-items:flex-start;">
              <label for="bgImage">Image</label>
              <input class="pFile" id="bgImage" type="file" accept="image/*" />
            </div>

            <div class="pRow">
              <button class="miniBtn" id="removeImage" type="button">Remove image</button>
            </div>

            <div class="pDiv"></div>

            <button class="miniBtn" id="bgApply" type="button">Apply background</button>
            <button class="miniBtn" id="bgReset" type="button" style="margin-top:8px;">Reset background</button>
          </div>
        </div>

      </div>
    </div>

    <div class="widgetBoard" id="board">
      <div class="boardTint" id="boardTint"></div>

      <div class="boardContent">
        <section class="controls" aria-label="Controls">
          <div class="field">
            <label for="search">Search</label>
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.8"/>
              <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
            <input class="input" id="search" type="search" placeholder="Title, location, tags…" autocomplete="off"/>
          </div>

          <div class="field">
            <label for="tagFilter">Tag filter</label>
            <select id="tagFilter">
              <option value="">All tags</option>
            </select>
          </div>

          <div class="field">
            <label for="startHour">Day starts</label>
            <select id="startHour"></select>
          </div>

          <div class="field">
            <label for="endHour">Day ends</label>
            <select id="endHour"></select>
          </div>
        </section>

        <section class="ttPanel" aria-label="Timetable panel">
          <div class="panelHead">
            <div class="meta">
              <span class="pill" id="countPill">0 blocks</span>
              <span class="pill" id="tagPill">0 tags</span>
            </div>
            <div class="meta" id="filteredMeta" aria-live="polite"></div>
          </div>

          <div id="panelBody"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">Add block</h3>
        <button class="btn" id="closeModalBtn" type="button" aria-label="Close">Close</button>
      </div>

      <form class="modalBody" id="blockForm">
        <input type="hidden" id="editId" value="" />

        <div class="formGrid">
          <div class="field">
            <label for="bTitle">Title</label>
            <input class="input2" id="bTitle" required maxlength="90" placeholder="e.g., Chem lecture / Study block" />
          </div>
          <div class="field">
            <label for="bDay">Day</label>
            <select class="select2" id="bDay" required>
              <option value="0">Mon</option>
              <option value="1">Tue</option>
              <option value="2">Wed</option>
              <option value="3">Thu</option>
              <option value="4">Fri</option>
              <option value="5">Sat</option>
              <option value="6">Sun</option>
            </select>
          </div>
        </div>

        <div class="formGrid">
          <div class="field">
            <label for="bStart">Start</label>
            <input class="input2" id="bStart" type="time" required />
          </div>
          <div class="field">
            <label for="bEnd">End</label>
            <input class="input2" id="bEnd" type="time" required />
          </div>
        </div>

        <div class="formGrid">
          <div class="field">
            <label for="bLocation">Location (optional)</label>
            <input class="input2" id="bLocation" maxlength="70" placeholder="e.g., Room 204 / Library / Zoom" />
          </div>
          <div class="field">
            <label for="bTags">Tags</label>
            <input class="input2" id="bTags" placeholder="comma-separated (e.g., class, study, work)" />
          </div>
        </div>

        <div class="field">
          <label for="bColor">Block colour</label>
          <div class="colorRow">
            <input class="colorInput" id="bColor" type="color" value="#ffffff" aria-label="Choose block colour"/>
          </div>
        </div>

        <div class="field">
          <label for="bNotes">Notes (optional)</label>
          <textarea class="textarea" id="bNotes" placeholder="Materials to bring, etc."></textarea>
        </div>

        <div class="modalFoot">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" type="button" id="cancelBtn">Cancel</button>
            <button class="btn primary" type="submit" id="saveBtn">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* =========================================================
       Instance-safe storage + GLOBAL presets (same pattern)
       - wid: per-widget unique id (URL ?wid=... or session fallback)
       - per-widget keys include wid so widgets don't overwrite each other
       - presets stored globally under widget_presets_v2
    ========================================================= */
    (function(){
      const mem = Object.create(null);

      function canUseLocalStorage(){
        try{
          const k="__t__"+Math.random().toString(16).slice(2);
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return true;
        }catch{ return false; }
      }
      const hasLS = canUseLocalStorage();

      function storageGet(key){
        try{ return hasLS ? localStorage.getItem(key) : (mem[key] ?? null); }
        catch{ return mem[key] ?? null; }
      }
      function storageSet(key, value){
        try{ if(hasLS) localStorage.setItem(key, value); else mem[key]=String(value); }
        catch{ mem[key]=String(value); }
      }
      function storageRemove(key){
        try{ if(hasLS) localStorage.removeItem(key); else delete mem[key]; }
        catch{ delete mem[key]; }
      }

      function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

      function getWidgetId(){
        try{
          const sp = new URLSearchParams(location.search);
          const wid = (sp.get("wid") || "").trim();
          if(wid) return wid;
        }catch{}
        try{
          const cached = sessionStorage.getItem("tt_wid");
          if(cached) return cached;
        }catch{}
        const fresh = uid();
        try{ sessionStorage.setItem("tt_wid", fresh); }catch{}
        return fresh;
      }

      window.__TT_APP__ = { wid: getWidgetId(), get: storageGet, set: storageSet, remove: storageRemove };
    })();

    const WID = window.__TT_APP__?.wid || "default";

    const LS_KEY = "weekly_timetable_v2__" + WID;
    const BG_KEY = "weekly_timetable_bg_v2__" + WID;
    const THEME_KEY = "weekly_timetable_theme_v2__" + WID;

    const PRESETS_KEY = "widget_presets_v2";
    const PRESET_NAMESPACE = "timetable";

    const els = {
      panelBody: document.getElementById("panelBody"),
      countPill: document.getElementById("countPill"),
      tagPill: document.getElementById("tagPill"),
      filteredMeta: document.getElementById("filteredMeta"),

      search: document.getElementById("search"),
      tagFilter: document.getElementById("tagFilter"),
      startHour: document.getElementById("startHour"),
      endHour: document.getElementById("endHour"),

      addBtn: document.getElementById("addBtn"),
      exportBtn: document.getElementById("exportBtn"),
      clearBtn: document.getElementById("clearBtn"),

      modalBackdrop: document.getElementById("modalBackdrop"),
      closeModalBtn: document.getElementById("closeModalBtn"),
      cancelBtn: document.getElementById("cancelBtn"),

      blockForm: document.getElementById("blockForm"),
      editId: document.getElementById("editId"),
      modalTitle: document.getElementById("modalTitle"),
      saveBtn: document.getElementById("saveBtn"),

      bTitle: document.getElementById("bTitle"),
      bDay: document.getElementById("bDay"),
      bStart: document.getElementById("bStart"),
      bEnd: document.getElementById("bEnd"),
      bLocation: document.getElementById("bLocation"),
      bTags: document.getElementById("bTags"),
      bNotes: document.getElementById("bNotes"),
      bColor: document.getElementById("bColor"),

      boardTint: document.getElementById("boardTint"),
      bgBtn: document.getElementById("bgBtn"),
      bgPanel: document.getElementById("bgPanel"),
      bgColor: document.getElementById("bgColor"),
      bgStrength: document.getElementById("bgStrength"),
      bgImage: document.getElementById("bgImage"),
      removeImage: document.getElementById("removeImage"),
      bgDot: document.getElementById("bgDot"),
      bgPopover: document.getElementById("bgPopover"),

      themeBtn: document.getElementById("themeBtn"),
      themePanel: document.getElementById("themePanel"),
      themePopover: document.getElementById("themePopover"),
      themeDot: document.getElementById("themeDot"),
      themeBg: document.getElementById("themeBg"),
      themeText: document.getElementById("themeText"),
      themeMuted: document.getElementById("themeMuted"),
      themeBorders: document.getElementById("themeBorders"),
      themeBorderAlpha: document.getElementById("themeBorderAlpha"),
      themeGridAlpha: document.getElementById("themeGridAlpha"),
      themePanelAlpha: document.getElementById("themePanelAlpha"),
      themeApply: document.getElementById("themeApply"),
      resetTheme: document.getElementById("resetTheme"),

      bgApply: document.getElementById("bgApply"),
      bgReset: document.getElementById("bgReset"),

      presetName: document.getElementById("presetName"),
      presetSave: document.getElementById("presetSave"),
      presetSelect: document.getElementById("presetSelect"),
      presetApply: document.getElementById("presetApply"),
      presetDelete: document.getElementById("presetDelete"),
      presetCopy: document.getElementById("presetCopy"),
      presetImport: document.getElementById("presetImport"),
      presetImportBtn: document.getElementById("presetImportBtn"),
      presetStatus: document.getElementById("presetStatus"),
    };

    const DAY_NAMES = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const nowISO = () => new Date().toISOString();

    const escapeHtml = (s) =>
      String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");

    const clamp = (n,a,b) => Math.max(a, Math.min(b, n));

    const normalizeHex = (hex, fallback="#ffffff") => {
      const s = String(hex || "").trim();
      return /^#[0-9a-fA-F]{6}$/.test(s) ? s.toLowerCase() : fallback;
    };

    const hexToRgb = (hex) => {
      const h = normalizeHex(hex).slice(1);
      const r = parseInt(h.slice(0,2), 16);
      const g = parseInt(h.slice(2,4), 16);
      const b = parseInt(h.slice(4,6), 16);
      return { r, g, b };
    };

    const hexToRgba = (hex, a) => {
      const { r, g, b } = hexToRgb(hex);
      return `rgba(${r},${g},${b},${a})`;
    };

    const alphaFromPct = (pct) => clamp(Number(pct) / 100, 0.01, 0.95);

    const setStatus = (msg="") => { if(els.presetStatus) els.presetStatus.textContent = msg; };

    const loadJSON = (key) => {
      try{
        const raw = window.__TT_APP__.get(key);
        return raw ? JSON.parse(raw) : null;
      }catch{ return null; }
    };
    const saveJSON = (key, val) => {
      try{ window.__TT_APP__.set(key, JSON.stringify(val)); }catch{}
    };

    async function copyText(text){
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch{}
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position="fixed";
        ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return !!ok;
      }catch{ return false; }
    }

    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    /* --------------------------
       Data storage (instance-safe)
    --------------------------- */
    const load = () => {
      try {
        const parsed = JSON.parse(window.__TT_APP__.get(LS_KEY) || "[]");
        return Array.isArray(parsed) ? parsed : [];
      } catch { return []; }
    };

    const save = (items) => {
      try { window.__TT_APP__.set(LS_KEY, JSON.stringify(items)); } catch {}
    };

    /* --------------------------
       Theme (draft + apply) + instance-safe
    --------------------------- */
    const DEFAULT_THEME = {
      bg: "#ffffff",
      text: "#2b2b2b",
      muted: "#6f6a63",
      border: "#2b2b2b",
      borderA: 12,     // 4..40
      gridA: 8,        // 3..30
      panelAlpha: 65   // 40..95
    };

    let themeDraft = Object.assign({}, DEFAULT_THEME, loadJSON(THEME_KEY) || {});

    const applyTheme = (theme, { persist=false } = {}) => {
      const t = {
        bg: normalizeHex(theme?.bg, DEFAULT_THEME.bg),
        text: normalizeHex(theme?.text, DEFAULT_THEME.text),
        muted: normalizeHex(theme?.muted, DEFAULT_THEME.muted),
        border: normalizeHex(theme?.border, DEFAULT_THEME.border),
        borderA: clamp(Number(theme?.borderA ?? DEFAULT_THEME.borderA), 4, 40),
        gridA: clamp(Number(theme?.gridA ?? DEFAULT_THEME.gridA), 3, 30),
        panelAlpha: clamp(Number(theme?.panelAlpha ?? DEFAULT_THEME.panelAlpha), 40, 95),
      };

      document.documentElement.style.setProperty("--bg", t.bg);
      document.documentElement.style.setProperty("--text", t.text);
      document.documentElement.style.setProperty("--muted", t.muted);

      document.documentElement.style.setProperty("--line", hexToRgba(t.border, alphaFromPct(t.borderA)));
      document.documentElement.style.setProperty("--gridLine", hexToRgba(t.border, alphaFromPct(t.gridA)));
      document.documentElement.style.setProperty("--focus", hexToRgba(t.border, 0.18));

      const pA = clamp(t.panelAlpha / 100, 0.4, 0.95);
      document.documentElement.style.setProperty("--panel", `rgba(255,255,255,${pA})`);
      document.documentElement.style.setProperty("--panel2", `rgba(255,255,255,${clamp(pA + 0.17, 0.5, 0.98)})`);

      els.themeDot.style.background = t.text;
      els.themeDot.style.boxShadow = `0 0 0 6px ${hexToRgba(t.text, 0.10)}`;

      // sync inputs to current draft/preview
      els.themeBg.value = t.bg;
      els.themeText.value = t.text;
      els.themeMuted.value = t.muted;
      els.themeBorders.value = t.border;
      els.themeBorderAlpha.value = String(t.borderA);
      els.themeGridAlpha.value = String(t.gridA);
      els.themePanelAlpha.value = String(t.panelAlpha);

      if(persist){
        saveJSON(THEME_KEY, t);
      }

      render(); // keep visuals consistent
      return t;
    };

    const readThemeUi = () => ({
      bg: els.themeBg.value,
      text: els.themeText.value,
      muted: els.themeMuted.value,
      border: els.themeBorders.value,
      borderA: Number(els.themeBorderAlpha.value),
      gridA: Number(els.themeGridAlpha.value),
      panelAlpha: Number(els.themePanelAlpha.value),
    });

    /* --------------------------
       Background (draft + apply) + instance-safe
    --------------------------- */
    const DEFAULT_BG = { tint:"#efe7e1", strength:35, imageDataUrl:null };
    let bgDraft = Object.assign({}, DEFAULT_BG, loadJSON(BG_KEY) || {});

    const setBoardImage = (dataUrlOrNull) => {
      document.documentElement.style.setProperty("--board-image", dataUrlOrNull ? `url("${dataUrlOrNull}")` : "none");
    };

    const applyBoardTint = (colorHex, strengthPct) => {
      const tint = normalizeHex(colorHex, DEFAULT_BG.tint);
      const strength = clamp(Number(strengthPct), 0, 70) / 100;

      document.documentElement.style.setProperty("--board-tint", tint);
      document.documentElement.style.setProperty("--board-tint-a", String(strength));

      els.bgDot.style.background = tint;
      els.bgDot.style.boxShadow = `0 0 0 6px ${hexToRgba(tint, Math.min(0.35, strength + 0.1))}`;

      els.boardTint.style.background = hexToRgba(tint, strength);
    };

    const fileToDataUrl = (file) =>
      new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });

    const applyBgDraft = () => {
      applyBoardTint(bgDraft.tint, bgDraft.strength);
      setBoardImage(bgDraft.imageDataUrl || null);

      els.bgColor.value = bgDraft.tint;
      els.bgStrength.value = String(bgDraft.strength);
    };

    /* --------------------------
       Presets (GLOBAL) — namespaced
       Each item: {id,name, ns, theme, bg}
    --------------------------- */
    function loadPresets(){
      const raw = loadJSON(PRESETS_KEY);
      const list = Array.isArray(raw) ? raw : [];
      return list;
    }
    function savePresets(list){
      saveJSON(PRESETS_KEY, list);
    }
    function refreshPresetSelect(){
      const list = loadPresets().filter(p => p && p.ns === PRESET_NAMESPACE);
      const cur = els.presetSelect.value;
      els.presetSelect.innerHTML = `<option value="">—</option>`;
      for(const p of list){
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name || "Untitled";
        els.presetSelect.appendChild(opt);
      }
      if(cur) els.presetSelect.value = cur;
    }
    function sanitizePresetList(parsed){
      if(!Array.isArray(parsed)) return null;
      return parsed.filter(Boolean).map(p => ({
        id: String(p.id || uid()),
        name: String(p.name || "Imported"),
        ns: String(p.ns || PRESET_NAMESPACE),
        theme: (p.theme && typeof p.theme === "object") ? p.theme : {},
        bg: (p.bg && typeof p.bg === "object") ? p.bg : {}
      }));
    }
    function getPresetById(id){
      return loadPresets().find(p => p && p.ns === PRESET_NAMESPACE && p.id === id) || null;
    }
    function applyPreset(p){
      // theme
      themeDraft = Object.assign({}, themeDraft, p.theme || {});
      themeDraft = applyTheme(themeDraft, { persist:true });

      // bg
      bgDraft = Object.assign({}, bgDraft, p.bg || {});
      applyBgDraft();
      saveJSON(BG_KEY, bgDraft);

      setStatus("Preset applied.");
    }

    /* --------------------------
       UI helpers / Confirm
    --------------------------- */
    const askConfirm = (message, { okText="Confirm", cancelText="Cancel", danger=false } = {}) =>
      new Promise((resolve) => {
        const wrap = document.createElement("div");
        wrap.style.position = "fixed";
        wrap.style.inset = "0";
        wrap.style.zIndex = "9999";
        wrap.style.display = "grid";
        wrap.style.placeItems = "center";
        wrap.style.padding = "18px";
        wrap.style.background = "rgba(20,18,16,.35)";
        wrap.style.backdropFilter = "blur(8px)";
        wrap.style.webkitBackdropFilter = "blur(8px)";

        wrap.innerHTML = `
          <div style="
            width:min(520px,100%);
            background:rgba(255,255,255,.92);
            border:1px solid rgba(43,43,43,.14);
            border-radius:20px;
            box-shadow:0 12px 40px rgba(0,0,0,.12);
            overflow:hidden;">
            <div style="padding:14px 16px;border-bottom:1px solid rgba(43,43,43,.10);font-weight:650;">
              Confirm
            </div>
            <div style="padding:14px 16px;line-height:1.45;color:rgba(43,43,43,.92);">
              ${escapeHtml(message)}
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
              padding:12px 16px;border-top:1px solid rgba(43,43,43,.10);">
              <button class="btn" type="button" id="cnlBtn">${escapeHtml(cancelText)}</button>
              <button class="btn ${danger ? "danger" : "primary"}" type="button" id="okBtn">${escapeHtml(okText)}</button>
            </div>
          </div>
        `;

        const cleanup = (val) => {
          document.removeEventListener("keydown", onKey);
          wrap.remove();
          resolve(val);
        };

        const onKey = (e) => { if (e.key === "Escape") cleanup(false); };

        wrap.addEventListener("click", (e) => {
          if (e.target === wrap) cleanup(false);
        });

        document.body.appendChild(wrap);
        document.addEventListener("keydown", onKey);

        wrap.querySelector("#cnlBtn").addEventListener("click", () => cleanup(false));
        const okBtn = wrap.querySelector("#okBtn");
        okBtn.addEventListener("click", () => cleanup(true));
        setTimeout(() => okBtn.focus(), 0);
      });

    /* --------------------------
       App state / render
    --------------------------- */
    let items = load();

    let state = { q:"", tag:"", startHour: 8, endHour: 20 };

    const hourLabel = (h) => {
      const ampm = h < 12 ? "AM" : "PM";
      const hr = h % 12 === 0 ? 12 : h % 12;
      return `${hr} ${ampm}`;
    };

    const fillHourSelect = (selectEl, selected) => {
      selectEl.innerHTML = "";
      for (let h=0; h<=24; h++){
        const opt = document.createElement("option");
        opt.value = String(h);
        opt.textContent = (h === 24) ? "12 AM (next day)" : hourLabel(h);
        if (h === selected) opt.selected = true;
        selectEl.appendChild(opt);
      }
    };

    fillHourSelect(els.startHour, state.startHour);
    fillHourSelect(els.endHour, state.endHour);

    const normalizeTags = (raw) => {
      if (!raw) return [];
      const parts = raw.split(",").map(s => s.trim().toLowerCase()).filter(Boolean);
      return [...new Set(parts)].slice(0, 14);
    };

    const buildTagOptions = (allItems) => {
      const tagSet = new Set();
      allItems.forEach(it => (it.tags || []).forEach(t => tagSet.add(t)));
      const tags = [...tagSet].sort((a,b) => a.localeCompare(b));
      const selected = els.tagFilter.value;

      els.tagFilter.innerHTML =
        `<option value="">All tags</option>` +
        tags.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      if ([...els.tagFilter.options].some(o => o.value === selected)) els.tagFilter.value = selected;
      els.tagPill.textContent = `${tags.length} tag${tags.length === 1 ? "" : "s"}`;
    };

    const matches = (it, q) => {
      if (!q) return true;
      const hay = [
        it.title, it.location, it.notes,
        it.dayName, it.start, it.end,
        ...(it.tags || [])
      ].join(" ").toLowerCase();
      return hay.includes(q.toLowerCase());
    };

    const applyFilters = () => {
      const q = state.q.trim();
      const tag = state.tag;

      let out = items.filter(it => matches(it, q));
      if (tag) out = out.filter(it => (it.tags || []).includes(tag));

      out.sort((a,b) => (a.day - b.day) || (a.start.localeCompare(b.start)));
      return out;
    };

    const timeToMinutes = (hhmm) => {
      const [h,m] = (hhmm || "").split(":").map(Number);
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h*60 + m;
    };

    const minutesToLabel = (mins) => {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      const ampm = h < 12 ? "AM" : "PM";
      const hr = h % 12 === 0 ? 12 : h % 12;
      return `${hr}:${String(m).padStart(2,"0")} ${ampm}`;
    };

    const withinRange = (startMin, endMin) => {
      const a = state.startHour * 60;
      const b = state.endHour * 60;
      return endMin > a && startMin < b;
    };

    const mixWithWhite = (hex, alphaToWhite = 0.72) => {
      const { r, g, b } = hexToRgb(hex);
      const rr = Math.round(r * (1 - alphaToWhite) + 255 * alphaToWhite);
      const gg = Math.round(g * (1 - alphaToWhite) + 255 * alphaToWhite);
      const bb = Math.round(b * (1 - alphaToWhite) + 255 * alphaToWhite);
      return `rgb(${rr} ${gg} ${bb})`;
    };

    const contrastInk = (hex) => {
      const { r, g, b } = hexToRgb(hex);
      const lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
      return lum < 0.55 ? "rgba(255,255,255,.92)" : "rgba(43,43,43,.92)";
    };

    // Build timetable DOM
    const renderTimetable = (filtered) => {
      const startMin = state.startHour * 60;
      const endMin = state.endHour * 60;
      const totalMin = Math.max(60, endMin - startMin);

      const pxPerMin = 1.2;
      const bodyHeight = Math.max(420, Math.round(totalMin * pxPerMin));

      const headerHtml = `
        <div class="ttHeader">
          <div class="corner">time</div>
          ${DAY_NAMES.map(d => `<div class="dayName">${d}</div>`).join("")}
        </div>
      `;

      const bodyHtml = `
        <div class="ttBody" id="ttBody" style="height:${bodyHeight}px">
          <div class="timeCol" id="timeCol"></div>
          ${DAY_NAMES.map((_,i)=>`<div class="dayCol" data-day="${i}" id="day_${i}"></div>`).join("")}
        </div>
      `;

      els.panelBody.innerHTML = `
        <div class="gridWrap">
          <div class="timetable">
            ${headerHtml}
            ${bodyHtml}
          </div>
        </div>
      `;

      const timeCol = document.getElementById("timeCol");

      for (let t=startMin; t<=endMin; t+=30){
        const y = ((t - startMin) / totalMin) * bodyHeight;
        const line = document.createElement("div");
        line.className = "hLine" + ((t % 60 === 0) ? " major" : "");
        line.style.top = `${y}px`;
        timeCol.appendChild(line);

        if (t % 60 === 0){
          const lbl = document.createElement("div");
          lbl.className = "timeLabel";
          lbl.style.top = `${y}px`;
          lbl.textContent = minutesToLabel(t);
          timeCol.appendChild(lbl);
        }
      }

      for (let i=0; i<7; i++){
        const col = document.getElementById(`day_${i}`);
        for (let t=startMin; t<=endMin; t+=30){
          const y = ((t - startMin) / totalMin) * bodyHeight;
          const line = document.createElement("div");
          line.className = "hLine" + ((t % 60 === 0) ? " major" : "");
          line.style.top = `${y}px`;
          col.appendChild(line);
        }
      }

      // themed line color
      const lineColor = getComputedStyle(document.documentElement).getPropertyValue("--line").trim() || "rgba(43,43,43,.12)";

      filtered.forEach((it) => {
        const s = timeToMinutes(it.start);
        const e = timeToMinutes(it.end);
        if (s == null || e == null) return;
        if (!withinRange(s,e)) return;

        const col = document.getElementById(`day_${it.day}`);
        if (!col) return;

        const top = ((clamp(s, startMin, endMin) - startMin) / totalMin) * bodyHeight;
        const bottom = ((clamp(e, startMin, endMin) - startMin) / totalMin) * bodyHeight;
        const height = Math.max(34, bottom - top);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "event";
        btn.style.top = `${top + 6}px`;
        btn.style.height = `${height - 12}px`;
        btn.setAttribute("aria-label", `${it.title} ${it.start} to ${it.end}`);

        const base = normalizeHex(it.color || "#ffffff");
        btn.style.background = mixWithWhite(base, 0.68);
        btn.style.borderColor = lineColor;
        btn.style.color = contrastInk(base);

        btn.innerHTML = `
          <div class="eventTitle">${escapeHtml(it.title)}</div>
          <div class="eventMeta">
            <span class="tinyPill">${escapeHtml(it.start)}–${escapeHtml(it.end)}</span>
            ${it.location ? `<span class="tinyPill">${escapeHtml(it.location)}</span>` : ""}
            ${(it.tags || []).slice(0,2).map(t => `<span class="tinyPill">${escapeHtml(t)}</span>`).join("")}
          </div>
          ${it.notes ? `<div class="eventNotes">${escapeHtml(it.notes)}</div>` : ""}
        `;

        btn.addEventListener("click", () => openEditModal(it.id));
        col.appendChild(btn);
      });

      const now = new Date();
      const jsDay = now.getDay(); // Sun=0 ... Sat=6
      const dayIndex = (jsDay + 6) % 7; // Mon=0 ... Sun=6
      const nowMin = now.getHours()*60 + now.getMinutes();

      if (nowMin >= startMin && nowMin <= endMin){
        const y = ((nowMin - startMin) / totalMin) * bodyHeight;
        const body = document.getElementById("ttBody");

        const line = document.createElement("div");
        line.className = "nowLine";
        line.style.top = `${y}px`;

        const dot = document.createElement("div");
        dot.className = "nowDot";
        dot.style.top = `${y}px`;

        body.appendChild(line);
        dot.style.left = `${78 + (dayIndex * ((body.clientWidth - 78) / 7))}px`;
        body.appendChild(dot);
      }
    };

    const renderEmpty = () => {
      els.panelBody.innerHTML = `
        <div class="empty">
          <div class="big" aria-hidden="true">▦</div>
          <h2>No blocks yet</h2>
          <button class="btn primary" type="button" id="emptyAddBtn">＋ Add your first block</button>
        </div>
      `;
      document.getElementById("emptyAddBtn").addEventListener("click", openAddModal);
    };

    const render = () => {
      buildTagOptions(items);
      const filtered = applyFilters();

      els.countPill.textContent = `${items.length} block${items.length === 1 ? "" : "s"}`;

      const parts = [];
      if (state.q) parts.push(`Search: “${state.q}”`);
      if (state.tag) parts.push(`Tag: ${state.tag}`);
      parts.push(`${state.startHour}:00–${state.endHour}:00`);
      els.filteredMeta.textContent = `${filtered.length} shown · ` + parts.join(" · ");

      if (items.length === 0){
        renderEmpty();
        return;
      }

      renderTimetable(filtered);
    };

    /* -------- CRUD -------- */
    const upsert = (payload) => {
      const idx = items.findIndex(x => x.id === payload.id);
      if (idx >= 0) items[idx] = payload;
      else items.unshift(payload);
      save(items);
      render();
    };

    const clearAll = async () => {
      if (!items.length) return;
      const ok = await askConfirm("Clear all blocks? This cannot be undone.", { okText: "Yes, clear", danger: true });
      if (!ok) return;
      items = [];
      save(items);
      render();
    };

    const exportJson = () => {
      const data = JSON.stringify(items, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "weekly-timetable.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    /* -------- Modal -------- */
    let lastFocusEl = null;

    const openModal = () => {
      lastFocusEl = document.activeElement;
      els.modalBackdrop.classList.add("show");
      setTimeout(() => els.bTitle.focus(), 0);
      document.addEventListener("keydown", onModalKeydown);
    };

    const closeModal = () => {
      els.modalBackdrop.classList.remove("show");
      document.removeEventListener("keydown", onModalKeydown);
      if (lastFocusEl && typeof lastFocusEl.focus === "function") lastFocusEl.focus();
      resetForm();
    };

    const onModalKeydown = (e) => {
      if (e.key === "Escape") closeModal();

      if (e.key === "Tab"){
        const focusables = els.modalBackdrop.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const list = [...focusables].filter(x => !x.disabled && x.offsetParent !== null);
        if (!list.length) return;

        const first = list[0];
        const last = list[list.length - 1];

        if (e.shiftKey && document.activeElement === first){
          e.preventDefault(); last.focus();
        } else if (!e.shiftKey && document.activeElement === last){
          e.preventDefault(); first.focus();
        }
      }
    };

    const resetForm = () => {
      els.editId.value = "";
      els.modalTitle.textContent = "Add block";
      els.saveBtn.textContent = "Save";

      els.bTitle.value = "";
      els.bDay.value = "0";
      els.bStart.value = "09:00";
      els.bEnd.value = "10:00";
      els.bLocation.value = "";
      els.bTags.value = "";
      els.bNotes.value = "";
      els.bColor.value = "#ffffff";
    };

    const openAddModal = () => { resetForm(); openModal(); };

    const openEditModal = (id) => {
      const it = items.find(x => x.id === id);
      if (!it) return;

      els.editId.value = it.id;
      els.modalTitle.textContent = "Edit block";
      els.saveBtn.textContent = "Update";

      els.bTitle.value = it.title || "";
      els.bDay.value = String(it.day ?? 0);
      els.bStart.value = it.start || "09:00";
      els.bEnd.value = it.end || "10:00";
      els.bLocation.value = it.location || "";
      els.bTags.value = (it.tags || []).join(", ");
      els.bNotes.value = it.notes || "";
      els.bColor.value = normalizeHex(it.color || "#ffffff");

      openModal();
    };

    /* --------------------------
       Popovers: mutually exclusive
    --------------------------- */
    function closeAll(except){
      [els.bgPanel, els.themePanel].forEach(p=>{
        if(!p) return;
        if(p !== except) p.classList.remove("open");
      });
    }

    els.bgBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const open = !els.bgPanel.classList.contains("open");
      closeAll(open ? els.bgPanel : null);
      els.bgPanel.classList.toggle("open", open);
    });

    els.themeBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const open = !els.themePanel.classList.contains("open");
      closeAll(open ? els.themePanel : null);
      els.themePanel.classList.toggle("open", open);
    });

    document.addEventListener("click", (e) => {
      const inside =
        els.bgPopover.contains(e.target) ||
        els.themePopover.contains(e.target);
      if(!inside) closeAll(null);
    });

    /* --------------------------
       Theme: draft/preview + apply/reset + presets
    --------------------------- */
    function onThemeInput(){
      themeDraft = Object.assign({}, themeDraft, readThemeUi());
      applyTheme(themeDraft, { persist:false }); // preview only
      setStatus("");
    }

    els.themeBg.addEventListener("input", onThemeInput);
    els.themeText.addEventListener("input", onThemeInput);
    els.themeMuted.addEventListener("input", onThemeInput);
    els.themeBorders.addEventListener("input", onThemeInput);
    els.themeBorderAlpha.addEventListener("input", onThemeInput);
    els.themeGridAlpha.addEventListener("input", onThemeInput);
    els.themePanelAlpha.addEventListener("input", onThemeInput);

    els.themeApply.addEventListener("click", () => {
      themeDraft = Object.assign({}, themeDraft, readThemeUi());
      themeDraft = applyTheme(themeDraft, { persist:true });
      setStatus("Theme applied.");
    });

    els.resetTheme.addEventListener("click", () => {
      themeDraft = Object.assign({}, DEFAULT_THEME);
      applyTheme(themeDraft, { persist:true });
      setStatus("Theme reset.");
    });

    /* Presets actions */
    function currentPresetPayload(){
      return {
        id: uid(),
        ns: PRESET_NAMESPACE,
        name: (els.presetName.value || "").trim() || "Untitled",
        theme: { ...themeDraft },
        bg: { ...bgDraft }
      };
    }

    function refreshPresets(){
      refreshPresetSelect();
    }

    refreshPresets();

    els.presetSave.addEventListener("click", () => {
      const name = (els.presetName.value || "").trim();
      if(!name){ setStatus("Type a preset name first."); return; }

      const list = loadPresets();
      list.unshift({ ...currentPresetPayload(), name });
      savePresets(list);

      els.presetName.value = "";
      refreshPresets();
      els.presetSelect.value = list[0].id;
      setStatus("Preset saved.");
    });

    els.presetApply.addEventListener("click", () => {
      const id = els.presetSelect.value || "";
      if(!id){ setStatus("Choose a preset first."); return; }
      const p = getPresetById(id);
      if(!p){ setStatus("Preset not found."); return; }
      applyPreset(p);
    });

    els.presetDelete.addEventListener("click", () => {
      const id = els.presetSelect.value || "";
      if(!id){ setStatus("Choose a preset first."); return; }
      const list = loadPresets();
      const next = list.filter(p => !(p && p.ns === PRESET_NAMESPACE && p.id === id));
      if(next.length === list.length){ setStatus("Preset not found."); return; }
      savePresets(next);
      refreshPresets();
      els.presetSelect.value = "";
      setStatus("Preset deleted.");
    });

    els.presetCopy.addEventListener("click", async () => {
      const payload = JSON.stringify(loadPresets(), null, 2);
      const ok = await copyText(payload);
      if(ok) setStatus("Preset JSON copied.");
      else{
        els.presetImport.value = payload;
        els.presetImport.focus(); els.presetImport.select();
        setStatus("Could not copy automatically — JSON placed in the box to copy manually.");
      }
    });

    els.presetImportBtn.addEventListener("click", () => {
      const raw = (els.presetImport.value || "").trim();
      if(!raw){ setStatus("Paste preset JSON first."); return; }
      try{
        const parsed = JSON.parse(raw);
        const cleaned = sanitizePresetList(parsed);
        if(!cleaned){ setStatus("That JSON doesn’t look like a preset list."); return; }
        savePresets(cleaned);
        refreshPresets();
        setStatus("Presets imported.");
      }catch{
        setStatus("Invalid JSON.");
      }
    });

    /* --------------------------
       Background: draft/preview + apply/reset
    --------------------------- */
    // init bg inputs and preview
    els.bgColor.value = bgDraft.tint;
    els.bgStrength.value = String(bgDraft.strength);
    applyBgDraft();

    els.bgColor.addEventListener("input", () => {
      bgDraft.tint = els.bgColor.value;
      applyBgDraft();
      setStatus("");
    });

    els.bgStrength.addEventListener("input", () => {
      bgDraft.strength = Number(els.bgStrength.value);
      applyBgDraft();
      setStatus("");
    });

    els.bgImage.addEventListener("change", async () => {
      const file = els.bgImage.files && els.bgImage.files[0];
      if (!file) return;
      const dataUrl = await fileToDataUrl(file);
      bgDraft.imageDataUrl = dataUrl;
      applyBgDraft();
      setStatus("");
    });

    els.removeImage.addEventListener("click", () => {
      bgDraft.imageDataUrl = null;
      els.bgImage.value = "";
      applyBgDraft();
      setStatus("");
    });

    els.bgApply.addEventListener("click", () => {
      saveJSON(BG_KEY, bgDraft);
      setStatus("Background applied.");
    });

    els.bgReset.addEventListener("click", () => {
      window.__TT_APP__.remove(BG_KEY);
      bgDraft = Object.assign({}, DEFAULT_BG);
      els.bgColor.value = DEFAULT_BG.tint;
      els.bgStrength.value = String(DEFAULT_BG.strength);
      els.bgImage.value = "";
      applyBgDraft();
      saveJSON(BG_KEY, bgDraft);
      setStatus("Background reset.");
    });

    /* --------------------------
       App events
    --------------------------- */
    els.addBtn.addEventListener("click", openAddModal);
    els.exportBtn.addEventListener("click", exportJson);
    els.clearBtn.addEventListener("click", clearAll);

    els.closeModalBtn.addEventListener("click", closeModal);
    els.cancelBtn.addEventListener("click", closeModal);
    els.modalBackdrop.addEventListener("click", (e) => {
      if (e.target === els.modalBackdrop) closeModal();
    });

    els.blockForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = els.bTitle.value.trim();
      const day = Number(els.bDay.value);
      const start = els.bStart.value;
      const end = els.bEnd.value;

      const s = timeToMinutes(start);
      const ee = timeToMinutes(end);

      if (!title || !Number.isFinite(day) || !start || !end) return;
      if (s == null || ee == null || ee <= s){
        await askConfirm("End time must be after start time.", { okText: "OK", cancelText: "Close" });
        return;
      }

      const location = (els.bLocation.value || "").trim();
      const tags = normalizeTags(els.bTags.value);
      const notes = (els.bNotes.value || "").trim();
      const color = normalizeHex(els.bColor.value, "#ffffff");

      const id = els.editId.value || (crypto?.randomUUID ? crypto.randomUUID() : uid());
      const existing = items.find(x => x.id === id);

      const payload = {
        id,
        title,
        day,
        dayName: DAY_NAMES[day],
        start,
        end,
        location,
        tags,
        notes,
        color,
        createdAt: existing ? existing.createdAt : nowISO(),
        updatedAt: nowISO(),
      };

      upsert(payload);
      closeModal();
    });

    els.search.addEventListener("input", () => { state.q = els.search.value; render(); });
    els.tagFilter.addEventListener("change", () => { state.tag = els.tagFilter.value; render(); });

    els.startHour.addEventListener("change", () => {
      const v = Number(els.startHour.value);
      state.startHour = Number.isFinite(v) ? v : 8;
      if (state.endHour <= state.startHour) {
        state.endHour = Math.min(24, state.startHour + 8);
        els.endHour.value = String(state.endHour);
      }
      render();
    });

    els.endHour.addEventListener("change", () => {
      const v = Number(els.endHour.value);
      state.endHour = Number.isFinite(v) ? v : 20;
      if (state.endHour <= state.startHour) {
        state.startHour = Math.max(0, state.endHour - 8);
        els.startHour.value = String(state.startHour);
      }
      render();
    });

    document.addEventListener("keydown", (e) => {
      if (els.modalBackdrop.classList.contains("show")) return;
      if (e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
        const a = document.activeElement;
        const typing = a && (a.tagName === "INPUT" || a.tagName === "TEXTAREA" || a.isContentEditable);
        if (!typing){
          e.preventDefault();
          els.search.focus();
        }
      }
    });

    /* --------------------------
       Boot: load saved theme/bg, but only PREVIEW. User can Apply.
    --------------------------- */
    themeDraft = Object.assign({}, DEFAULT_THEME, loadJSON(THEME_KEY) || {});
    themeDraft = applyTheme(themeDraft, { persist:false }); // preview
    // sync draft inputs
    // (applyTheme already syncs inputs)

    bgDraft = Object.assign({}, DEFAULT_BG, loadJSON(BG_KEY) || {});
    applyBgDraft();

    render();

    window.addEventListener("resize", () => {
      clearTimeout(window.__wt_resize);
      window.__wt_resize = setTimeout(render, 120);
    });
  </script>
</body>
</html>
