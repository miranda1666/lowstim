<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Timetable</title>
  <style>
    :root{
      --bg: #ffffff;
      --panel: rgba(255,255,255,.65);
      --panel2: rgba(255,255,255,.82);
      --text: #2b2b2b;
      --muted: #6f6a63;
      --line: rgba(43,43,43,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --shadow2: 0 16px 50px rgba(0,0,0,.14);
      --radius: 18px;
      --radius2: 14px;
      --focus: rgba(43,43,43,.18);
      --gridLine: rgba(43,43,43,.08);
      --inkSoft: rgba(43,43,43,.60);

      /* Widget-board background (only behind controls + panel) */
      --board-tint: #efe7e1;
      --board-tint-a: 0.35;
      --board-image: none; /* url(...) injected by JS */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 18px 40px;
    }

    /* Header */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .title{
      display:grid;
      gap: 6px;
      min-width: 280px;
    }
    .title h1{
      font-size: clamp(22px, 2.6vw, 32px);
      line-height: 1.1;
      margin: 0;
      letter-spacing: -.02em;
    }
    .title p{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 62ch;
      line-height: 1.4;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.68));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.08); border-color: rgba(43,43,43,.18); }
    .btn:active{ transform: translateY(0px); }
    .btn:focus-visible{ outline: 3px solid var(--focus); outline-offset: 2px; }
    .btn.primary{ border-color: rgba(43,43,43,.14); }
    .btn.danger{ border-color: rgba(160, 60, 60, .20); }

    /* Discreet popovers */
    .popover{ position: relative; }

    .bgBtn{
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.68));
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .bgBtn:active{ transform: translateY(1px); }

    .bgDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,43,.14);
      background: var(--board-tint);
      box-shadow: 0 0 0 6px rgba(239,231,225,0.35);
    }
    .themeDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(43,43,43,.14);
      background: var(--text);
      box-shadow: 0 0 0 6px rgba(239,231,225,0.35);
    }

    .bgPanel{
      position: absolute;
      top: 50px;
      right: 0;
      width: 260px;
      border-radius: 16px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px;
      display:none;
      z-index: 60;
    }
    .bgPanel.open{ display:block; }
    .bgPanel h3{
      margin: 0 0 10px 0;
      font-size: 13px;
      font-weight: 650;
      color: rgba(43,43,43,.85);
    }
    .bgRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 0;
    }
    .bgRow label{
      font-size: 12px;
      color: var(--muted);
      padding-left: 0;
    }
    input[type="color"].bgColor{
      width: 34px;
      height: 26px;
      border: 1px solid rgba(43,43,43,.14);
      border-radius: 10px;
      padding: 0;
      background: transparent;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    input[type="range"].bgStrength{ width: 140px; }
    .bgFile{
      width: 100%;
      font-size: 12px;
      color: rgba(43,43,43,.75);
    }
    .bgMiniBtn{
      width: 100%;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 9px 10px;
      cursor: pointer;
      font-weight: 650;
      color: rgba(43,43,43,.85);
      -webkit-tap-highlight-color: transparent;
    }
    .bgMiniBtn:active{ transform: translateY(1px); }
    .bgDivider{
      height: 1px;
      background: rgba(43,43,43,.08);
      margin: 8px 0;
    }

    /* Theme panel opens to the left */
    .themePanel{ right: 50px; }

    /* Widget board (ONLY behind controls + panel) */
    .widgetBoard{
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
    }
    .widgetBoard::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--board-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(.95);
      transform: scale(1.02);
      pointer-events:none;
    }
    .widgetBoard::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 520px at 18% 20%, rgba(255,255,255,0.35), transparent 62%),
        radial-gradient(700px 460px at 82% 34%, rgba(255,255,255,0.25), transparent 62%),
        rgba(255,255,255,0.38);
      background-blend-mode: screen;
      pointer-events:none;
    }
    .boardTint{
      position:absolute;
      inset:0;
      pointer-events:none;
      mix-blend-mode: multiply;
    }
    .boardContent{
      position: relative;
      z-index: 2;
    }

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns: 1.1fr .7fr .6fr .6fr;
      gap: 10px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      align-items: end;
    }

    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 620px){
      .controls{ grid-template-columns: 1fr; }
      .actions{ width:100%; justify-content:flex-start; }
    }

    .field{ position: relative; display:grid; gap: 6px; }
    label{ font-size: 12px; color: var(--muted); padding-left: 6px; }
    .input, select{
      width:100%;
      padding: 12px 12px 12px 40px;
      border-radius: 14px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.75);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
      font-size: 14px;
      color: var(--text);
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    select{ padding-left: 12px; }
    .input:focus, select:focus{
      border-color: rgba(43,43,43,.22);
      box-shadow: 0 0 0 3px rgba(43,43,43,.10);
    }
    .icon{
      position:absolute;
      left: 12px;
      top: 36px;
      width: 16px;
      height: 16px;
      opacity: .65;
      pointer-events:none;
    }

    /* Panel */
    .panel{
      margin-top: 16px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow: hidden;
    }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(43,43,43,.08);
      flex-wrap: wrap;
    }
    .meta{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .pill{
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.65);
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
    }

    /* Timetable */
    .gridWrap{ padding: 14px; }
    .timetable{
      width: 100%;
      border-radius: var(--radius2);
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.62);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
      overflow: hidden;
    }

    .ttHeader{
      display:grid;
      grid-template-columns: 78px repeat(7, minmax(0, 1fr));
      gap: 0;
      border-bottom: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.72);
    }
    .ttHeader div{
      padding: 10px 10px;
      font-size: 12px;
      color: var(--muted);
      border-right: 1px solid rgba(43,43,43,.08);
    }
    .ttHeader div:last-child{ border-right: none; }
    .ttHeader .corner{ color: rgba(43,43,43,.55); }
    .dayName{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      font-weight: 650;
      color: rgba(43,43,43,.78);
      letter-spacing: -.01em;
    }

    .ttBody{
      position: relative;
      height: 720px;
      display:grid;
      grid-template-columns: 78px repeat(7, minmax(0, 1fr));
    }

    .timeCol{
      border-right: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.62);
      position: relative;
    }
    .timeLabel{
      position: absolute;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      padding: 0 10px;
      font-size: 11px;
      color: rgba(43,43,43,.62);
      text-align: right;
      pointer-events:none;
    }

    .dayCol{
      position: relative;
      border-right: 1px solid rgba(43,43,43,.08);
      background: rgba(255,255,255,.55);
    }
    .dayCol:last-child{ border-right: none; }

    .hLine{
      position:absolute;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--gridLine);
      opacity: .9;
      pointer-events:none;
    }
    .hLine.major{ background: rgba(43,43,43,.10); }

    .event{
      position:absolute;
      left: 8px;
      right: 8px;
      border-radius: 14px;
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.72);
      box-shadow:
        0 10px 22px rgba(0,0,0,.06),
        inset 0 1px 0 rgba(255,255,255,.88);
      padding: 10px 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      overflow: hidden;
    }
    .event:hover{
      transform: translateY(-1px);
      box-shadow:
        0 14px 30px rgba(0,0,0,.09),
        inset 0 1px 0 rgba(255,255,255,.90);
      border-color: rgba(43,43,43,.16);
    }
    .event:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 3px;
    }
    .eventTitle{
      font-weight: 750;
      font-size: 12.5px;
      letter-spacing: -.01em;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .eventMeta{
      font-size: 11.5px;
      color: rgba(43,43,43,.62);
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .tinyPill{
      font-size: 11px;
      color: rgba(43,43,43,.76);
      border: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.60);
      padding: 3px 8px;
      border-radius: 999px;
    }
    .eventNotes{
      font-size: 11.5px;
      color: rgba(43,43,43,.68);
      line-height: 1.35;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .nowLine{
      position:absolute;
      left: 0;
      right: 0;
      height: 1px;
      background: rgba(43,43,43,.22);
      opacity: .8;
      pointer-events:none;
    }
    .nowDot{
      position:absolute;
      left: 78px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(43,43,43,.72);
      transform: translate(-50%, -50%);
      opacity: .85;
      pointer-events:none;
    }

    .empty{
      padding: 44px 18px 50px;
      display:grid;
      place-items:center;
      text-align:center;
      gap: 12px;
      color: var(--muted);
    }
    .empty .big{
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.7);
      display:grid;
      place-items:center;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 12px 30px rgba(0,0,0,.06);
      font-size: 22px;
    }
    .empty h2{ margin:0; color: var(--text); font-size: 16px; letter-spacing: -.01em; }
    .empty p{ margin:0; max-width: 60ch; font-size: 13.5px; line-height: 1.5; }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      padding: 18px;
      background: rgba(20,18,16,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 50;
    }
    .modalBackdrop.show{ display: grid; }

    .modal{
      width: min(820px, 100%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(43,43,43,.14);
      border-radius: 20px;
      box-shadow: var(--shadow2);
      overflow: hidden;
    }
    .modalHead{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.72);
    }
    .modalHead h3{ margin:0; font-size: 15px; letter-spacing: -.01em; }

    /* icon button (was missing in your CSS, adding minimally) */
    .iconBtn{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.70);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn svg{ width:18px; height:18px; opacity:.75; }
    .iconBtn:active{ transform: translateY(1px); }

    .modalBody{
      padding: 14px 16px 16px;
      display:grid;
      gap: 12px;
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 760px){ .formGrid{ grid-template-columns: 1fr; } }

    .input2, .textarea, .select2{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.78);
      font-size: 14px;
      color: var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    .textarea{ min-height: 88px; resize: vertical; }
    .input2:focus, .textarea:focus, .select2:focus{
      border-color: rgba(43,43,43,.22);
      box-shadow: 0 0 0 3px rgba(43,43,43,.10);
    }

    .modalFoot{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px 16px 14px;
      border-top: 1px solid rgba(43,43,43,.10);
      background: rgba(255,255,255,.70);
      flex-wrap: wrap;
    }

    .floor{
      height: 18px;
      background: linear-gradient(180deg, rgba(212,199,188,.8), rgba(188,171,156,.75));
      border-top: 1px solid rgba(43,43,43,.12);
    }

    .colorRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .colorInput{
      width: 44px;
      height: 38px;
      padding: 0;
      border-radius: 12px;
      border: 1px solid rgba(43,43,43,.14);
      background: rgba(255,255,255,.75);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Timetable</h1>
      </div>
      <div class="actions">
        <button class="btn primary" id="addBtn" type="button">
          <span aria-hidden="true">＋</span> Add block
        </button>
        <button class="btn" id="exportBtn" type="button">
          <span aria-hidden="true">⤓</span> Export
        </button>
        <button class="btn danger" id="clearBtn" type="button">
          <span aria-hidden="true">✕</span> Clear
        </button>

        <!-- THEME POPOVER -->
        <div class="popover" id="themePopover">
          <button class="bgBtn" id="themeBtn" type="button" aria-label="Theme settings" title="Theme settings">
            <span class="themeDot" id="themeDot" aria-hidden="true"></span>
          </button>

          <div class="bgPanel themePanel" id="themePanel" role="dialog" aria-label="Theme settings">
            <h3>Theme</h3>

            <div class="bgRow">
              <label for="tBg">Page bg</label>
              <input class="bgColor" id="tBg" type="color" value="#ffffff" />
            </div>

            <div class="bgRow">
              <label for="tText">Text</label>
              <input class="bgColor" id="tText" type="color" value="#2b2b2b" />
            </div>

            <div class="bgRow">
              <label for="tMuted">Muted</label>
              <input class="bgColor" id="tMuted" type="color" value="#6f6a63" />
            </div>

            <div class="bgRow">
              <label for="tLine">Borders</label>
              <input class="bgColor" id="tLine" type="color" value="#cfcac3" />
            </div>

            <div class="bgDivider"></div>

            <div class="bgRow">
              <label for="tPanelA">Panel opacity</label>
              <input class="bgStrength" id="tPanelA" type="range" min="35" max="95" value="65" />
            </div>

            <div class="bgRow">
              <label for="tPanel2A">Panel 2 opacity</label>
              <input class="bgStrength" id="tPanel2A" type="range" min="35" max="98" value="82" />
            </div>

            <div class="bgDivider"></div>

            <div class="bgRow">
              <button class="bgMiniBtn" id="themeReset" type="button">Reset theme</button>
            </div>
          </div>
        </div>

        <!-- BACKGROUND POPOVER -->
        <div class="popover" id="bgPopover">
          <button class="bgBtn" id="bgBtn" type="button" aria-label="Background settings" title="Background settings">
            <span class="bgDot" id="bgDot" aria-hidden="true"></span>
          </button>

          <div class="bgPanel" id="bgPanel" role="dialog" aria-label="Background settings">
            <h3>Background</h3>

            <div class="bgRow">
              <label for="bgColor">Tint</label>
              <input class="bgColor" id="bgColor" type="color" value="#efe7e1" />
            </div>

            <div class="bgRow">
              <label for="bgStrength">Tint strength</label>
              <input class="bgStrength" id="bgStrength" type="range" min="0" max="70" value="35" />
            </div>

            <div class="bgDivider"></div>

            <div class="bgRow" style="align-items:flex-start;">
              <label for="bgImage">Image</label>
              <input class="bgFile" id="bgImage" type="file" accept="image/*" />
            </div>

            <div class="bgRow">
              <button class="bgMiniBtn" id="removeImage" type="button">Remove image</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="widgetBoard" id="board">
      <div class="boardTint" id="boardTint"></div>

      <div class="boardContent">
        <section class="controls" aria-label="Controls">
          <div class="field">
            <label for="search">Search</label>
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.8"/>
              <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
            <input class="input" id="search" type="search" placeholder="Title, location, tags…" autocomplete="off"/>
          </div>

          <div class="field">
            <label for="tagFilter">Tag filter</label>
            <select id="tagFilter">
              <option value="">All tags</option>
            </select>
          </div>

          <div class="field">
            <label for="startHour">Day starts</label>
            <select id="startHour"></select>
          </div>

          <div class="field">
            <label for="endHour">Day ends</label>
            <select id="endHour"></select>
          </div>
        </section>

        <section class="panel" aria-label="Timetable panel">
          <div class="panelHead">
            <div class="meta">
              <span class="pill" id="countPill">0 blocks</span>
              <span class="pill" id="tagPill">0 tags</span>
            </div>
            <div class="meta" id="filteredMeta" aria-live="polite"></div>
          </div>

          <div id="panelBody"></div>
          <div class="floor" aria-hidden="true"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">Add block</h3>
        <button class="iconBtn" id="closeModalBtn" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6 18 18M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <form class="modalBody" id="blockForm">
        <input type="hidden" id="editId" value="" />

        <div class="formGrid">
          <div class="field">
            <label for="bTitle">Title</label>
            <input class="input2" id="bTitle" required maxlength="90" placeholder="e.g., Chem lecture / Study block" />
          </div>
          <div class="field">
            <label for="bDay">Day</label>
            <select class="select2" id="bDay" required>
              <option value="0">Mon</option>
              <option value="1">Tue</option>
              <option value="2">Wed</option>
              <option value="3">Thu</option>
              <option value="4">Fri</option>
              <option value="5">Sat</option>
              <option value="6">Sun</option>
            </select>
          </div>
        </div>

        <div class="formGrid">
          <div class="field">
            <label for="bStart">Start</label>
            <input class="input2" id="bStart" type="time" required />
          </div>
          <div class="field">
            <label for="bEnd">End</label>
            <input class="input2" id="bEnd" type="time" required />
          </div>
        </div>

        <div class="formGrid">
          <div class="field">
            <label for="bLocation">Location (optional)</label>
            <input class="input2" id="bLocation" maxlength="70" placeholder="e.g., Room 204 / Library / Zoom" />
          </div>
          <div class="field">
            <label for="bTags">Tags</label>
            <input class="input2" id="bTags" placeholder="comma-separated (e.g., class, study, work)" />
          </div>
        </div>

        <div class="field">
          <label for="bColor">Block colour</label>
          <div class="colorRow">
            <input class="colorInput" id="bColor" type="color" value="#ffffff" aria-label="Choose block colour"/>
          </div>
        </div>

        <div class="field">
          <label for="bNotes">Notes (optional)</label>
          <textarea class="textarea" id="bNotes" placeholder="Materials to bring, etc."></textarea>
        </div>

        <div class="modalFoot">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" type="button" id="cancelBtn">Cancel</button>
            <button class="btn primary" type="submit" id="saveBtn">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    const LS_KEY = "weekly_timetable_v1";
    const BG_KEY = "weekly_timetable_bg_v1";
    const THEME_KEY = "weekly_timetable_theme_v1";

    const els = {
      panelBody: document.getElementById("panelBody"),
      countPill: document.getElementById("countPill"),
      tagPill: document.getElementById("tagPill"),
      filteredMeta: document.getElementById("filteredMeta"),

      search: document.getElementById("search"),
      tagFilter: document.getElementById("tagFilter"),
      startHour: document.getElementById("startHour"),
      endHour: document.getElementById("endHour"),

      addBtn: document.getElementById("addBtn"),
      exportBtn: document.getElementById("exportBtn"),
      clearBtn: document.getElementById("clearBtn"),

      modalBackdrop: document.getElementById("modalBackdrop"),
      closeModalBtn: document.getElementById("closeModalBtn"),
      cancelBtn: document.getElementById("cancelBtn"),

      blockForm: document.getElementById("blockForm"),
      editId: document.getElementById("editId"),
      modalTitle: document.getElementById("modalTitle"),
      saveBtn: document.getElementById("saveBtn"),

      bTitle: document.getElementById("bTitle"),
      bDay: document.getElementById("bDay"),
      bStart: document.getElementById("bStart"),
      bEnd: document.getElementById("bEnd"),
      bLocation: document.getElementById("bLocation"),
      bTags: document.getElementById("bTags"),
      bNotes: document.getElementById("bNotes"),
      bColor: document.getElementById("bColor"),

      board: document.getElementById("board"),
      boardTint: document.getElementById("boardTint"),
      bgBtn: document.getElementById("bgBtn"),
      bgPanel: document.getElementById("bgPanel"),
      bgColor: document.getElementById("bgColor"),
      bgStrength: document.getElementById("bgStrength"),
      bgImage: document.getElementById("bgImage"),
      removeImage: document.getElementById("removeImage"),
      bgDot: document.getElementById("bgDot"),
      bgPopover: document.getElementById("bgPopover"),

      themeBtn: document.getElementById("themeBtn"),
      themePanel: document.getElementById("themePanel"),
      themePopover: document.getElementById("themePopover"),
      themeDot: document.getElementById("themeDot"),

      tBg: document.getElementById("tBg"),
      tText: document.getElementById("tText"),
      tMuted: document.getElementById("tMuted"),
      tLine: document.getElementById("tLine"),
      tPanelA: document.getElementById("tPanelA"),
      tPanel2A: document.getElementById("tPanel2A"),
      themeReset: document.getElementById("themeReset"),
    };

    const DAY_NAMES = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const nowISO = () => new Date().toISOString();

    const escapeHtml = (s) =>
      String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");

    const normalizeTags = (raw) => {
      if (!raw) return [];
      const parts = raw.split(",").map(s => s.trim().toLowerCase()).filter(Boolean);
      return [...new Set(parts)].slice(0, 14);
    };

    const load = () => {
      try {
        const parsed = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        return Array.isArray(parsed) ? parsed : [];
      } catch {}
      try {
        const parsed = JSON.parse(sessionStorage.getItem(LS_KEY) || "[]");
        return Array.isArray(parsed) ? parsed : [];
      } catch { return []; }
    };

    const save = (items) => {
      const data = JSON.stringify(items);
      try { localStorage.setItem(LS_KEY, data); return; } catch {}
      try { sessionStorage.setItem(LS_KEY, data); return; } catch {}
    };

    const loadBg = () => {
      try{
        const raw = localStorage.getItem(BG_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch{ return null; }
    };

    const saveBg = (bg) => {
      try{ localStorage.setItem(BG_KEY, JSON.stringify(bg)); }catch{}
    };

    // -------- THEME persistence --------
    const defaultTheme = () => ({
      bg: "#ffffff",
      text: "#2b2b2b",
      muted: "#6f6a63",
      line: "#cfcac3",
      panelA: 65,
      panel2A: 82
    });

    const loadTheme = () => {
      try{
        const raw = localStorage.getItem(THEME_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch{ return null; }
    };

    const saveTheme = (t) => {
      try{ localStorage.setItem(THEME_KEY, JSON.stringify(t)); }catch{}
    };

    const clamp = (n,a,b) => Math.max(a, Math.min(b, n));

    const hexToRgb = (hex) => {
      const s = String(hex || "#000000").trim();
      const m = s.match(/^#([0-9a-f]{6})$/i);
      const h = (m ? m[1] : "000000").toLowerCase();
      const r = parseInt(h.slice(0,2), 16);
      const g = parseInt(h.slice(2,4), 16);
      const b = parseInt(h.slice(4,6), 16);
      return { r, g, b };
    };

    const rgbaFromHex = (hex, a) => {
      const { r,g,b } = hexToRgb(hex);
      return `rgba(${r},${g},${b},${a})`;
    };

    const setThemeDot = (inkHex) => {
      if (!els.themeDot) return;
      els.themeDot.style.background = inkHex;
      els.themeDot.style.boxShadow = `0 0 0 6px ${rgbaFromHex(inkHex, 0.18)}`;
    };

    const applyTheme = (t) => {
      const base = defaultTheme();
      const theme = Object.assign(base, t || {});

      const panelA = clamp(Number(theme.panelA ?? 65), 35, 95) / 100;
      const panel2A = clamp(Number(theme.panel2A ?? 82), 35, 98) / 100;

      document.documentElement.style.setProperty("--bg", theme.bg);
      document.documentElement.style.setProperty("--text", theme.text);
      document.documentElement.style.setProperty("--muted", theme.muted);
      document.documentElement.style.setProperty("--line", rgbaFromHex(theme.line, 0.12)); /* keep line subtle */
      document.documentElement.style.setProperty("--focus", rgbaFromHex(theme.text, 0.18));
      document.documentElement.style.setProperty("--gridLine", rgbaFromHex(theme.text, 0.08));
      document.documentElement.style.setProperty("--inkSoft", rgbaFromHex(theme.text, 0.60));

      document.documentElement.style.setProperty("--panel", rgbaFromHex("#ffffff", panelA));
      document.documentElement.style.setProperty("--panel2", rgbaFromHex("#ffffff", panel2A));

      setThemeDot(theme.text);
    };

    const initTheme = () => {
      if (!els.themeBtn || !els.themePanel || !els.tBg || !els.tText || !els.tMuted || !els.tLine || !els.tPanelA || !els.tPanel2A || !els.themeReset) return;

      const loaded = loadTheme() || defaultTheme();

      els.tBg.value = loaded.bg;
      els.tText.value = loaded.text;
      els.tMuted.value = loaded.muted;
      els.tLine.value = loaded.line;
      els.tPanelA.value = String(loaded.panelA ?? 65);
      els.tPanel2A.value = String(loaded.panel2A ?? 82);

      applyTheme(loaded);

      const update = () => {
        const next = {
          bg: els.tBg.value,
          text: els.tText.value,
          muted: els.tMuted.value,
          line: els.tLine.value,
          panelA: Number(els.tPanelA.value),
          panel2A: Number(els.tPanel2A.value),
        };
        applyTheme(next);
        saveTheme(next);
      };

      [els.tBg, els.tText, els.tMuted, els.tLine].forEach(inp => inp.addEventListener("input", update));
      [els.tPanelA, els.tPanel2A].forEach(inp => inp.addEventListener("input", update));

      els.themeReset.addEventListener("click", () => {
        localStorage.removeItem(THEME_KEY);
        const def = defaultTheme();
        els.tBg.value = def.bg;
        els.tText.value = def.text;
        els.tMuted.value = def.muted;
        els.tLine.value = def.line;
        els.tPanelA.value = String(def.panelA);
        els.tPanel2A.value = String(def.panel2A);
        applyTheme(def);
        saveTheme(def);
      });
    };

    // confirm modal helper (unchanged)
    const askConfirm = (message, { okText="Confirm", cancelText="Cancel", danger=false } = {}) =>
      new Promise((resolve) => {
        const wrap = document.createElement("div");
        wrap.style.position = "fixed";
        wrap.style.inset = "0";
        wrap.style.zIndex = "9999";
        wrap.style.display = "grid";
        wrap.style.placeItems = "center";
        wrap.style.padding = "18px";
        wrap.style.background = "rgba(20,18,16,.35)";
        wrap.style.backdropFilter = "blur(8px)";
        wrap.style.webkitBackdropFilter = "blur(8px)";

        wrap.innerHTML = `
          <div style="
            width:min(520px,100%);
            background:rgba(255,255,255,.92);
            border:1px solid rgba(43,43,43,.14);
            border-radius:20px;
            box-shadow:0 12px 40px rgba(0,0,0,.12);
            overflow:hidden;">
            <div style="padding:14px 16px;border-bottom:1px solid rgba(43,43,43,.10);font-weight:650;">
              Confirm
            </div>
            <div style="padding:14px 16px;line-height:1.45;color:rgba(43,43,43,.92);">
              ${escapeHtml(message)}
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
              padding:12px 16px;border-top:1px solid rgba(43,43,43,.10);">
              <button class="btn" type="button" id="cnlBtn">${escapeHtml(cancelText)}</button>
              <button class="btn ${danger ? "danger" : "primary"}" type="button" id="okBtn">${escapeHtml(okText)}</button>
            </div>
          </div>
        `;

        const cleanup = (val) => {
          document.removeEventListener("keydown", onKey);
          wrap.remove();
          resolve(val);
        };

        const onKey = (e) => { if (e.key === "Escape") cleanup(false); };

        wrap.addEventListener("click", (e) => {
          if (e.target === wrap) cleanup(false);
        });

        document.body.appendChild(wrap);
        document.addEventListener("keydown", onKey);

        const okBtn = wrap.querySelector("#okBtn");
        const cnlBtn = wrap.querySelector("#cnlBtn");

        cnlBtn.addEventListener("click", () => cleanup(false));
        okBtn.addEventListener("click", () => cleanup(true));

        setTimeout(() => okBtn.focus(), 0);
      });

    let items = load();

    // state
    let state = { q: "", tag: "", startHour: 8, endHour: 20 };

    const hourLabel = (h) => {
      const ampm = h < 12 ? "AM" : "PM";
      const hr = h % 12 === 0 ? 12 : h % 12;
      return `${hr} ${ampm}`;
    };

    const fillHourSelect = (selectEl, selected) => {
      selectEl.innerHTML = "";
      for (let h=0; h<=24; h++){
        const opt = document.createElement("option");
        opt.value = String(h);
        opt.textContent = (h === 24) ? "12 AM (next day)" : hourLabel(h);
        if (h === selected) opt.selected = true;
        selectEl.appendChild(opt);
      }
    };

    fillHourSelect(els.startHour, state.startHour);
    fillHourSelect(els.endHour, state.endHour);

    const buildTagOptions = (allItems) => {
      const tagSet = new Set();
      allItems.forEach(it => (it.tags || []).forEach(t => tagSet.add(t)));
      const tags = [...tagSet].sort((a,b) => a.localeCompare(b));
      const selected = els.tagFilter.value;

      els.tagFilter.innerHTML =
        `<option value="">All tags</option>` +
        tags.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      if ([...els.tagFilter.options].some(o => o.value === selected)) els.tagFilter.value = selected;
      els.tagPill.textContent = `${tags.length} tag${tags.length === 1 ? "" : "s"}`;
    };

    const matches = (it, q) => {
      if (!q) return true;
      const hay = [
        it.title, it.location, it.notes,
        it.dayName, it.start, it.end,
        ...(it.tags || [])
      ].join(" ").toLowerCase();
      return hay.includes(q.toLowerCase());
    };

    const applyFilters = () => {
      const q = state.q.trim();
      const tag = state.tag;

      let out = items.filter(it => matches(it, q));
      if (tag) out = out.filter(it => (it.tags || []).includes(tag));

      out.sort((a,b) => (a.day - b.day) || (a.start.localeCompare(b.start)));
      return out;
    };

    const timeToMinutes = (hhmm) => {
      const [h,m] = (hhmm || "").split(":").map(Number);
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h*60 + m;
    };

    const minutesToLabel = (mins) => {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      const ampm = h < 12 ? "AM" : "PM";
      const hr = h % 12 === 0 ? 12 : h % 12;
      return `${hr}:${String(m).padStart(2,"0")} ${ampm}`;
    };

    const withinRange = (startMin, endMin) => {
      const a = state.startHour * 60;
      const b = state.endHour * 60;
      return endMin > a && startMin < b;
    };

    const clampNum = (n,a,b) => Math.max(a, Math.min(b, n));

    const normalizeHex = (hex) => {
      if (!hex) return "#ffffff";
      const s = String(hex).trim();
      if (/^#[0-9a-fA-F]{6}$/.test(s)) return s.toLowerCase();
      return "#ffffff";
    };

    const mixWithWhite = (hex, alphaToWhite = 0.72) => {
      const { r, g, b } = hexToRgb(hex);
      const rr = Math.round(r * (1 - alphaToWhite) + 255 * alphaToWhite);
      const gg = Math.round(g * (1 - alphaToWhite) + 255 * alphaToWhite);
      const bb = Math.round(b * (1 - alphaToWhite) + 255 * alphaToWhite);
      return `rgb(${rr} ${gg} ${bb})`;
    };

    const contrastInk = (hex) => {
      const { r, g, b } = hexToRgb(hex);
      const lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
      return lum < 0.55 ? "rgba(255,255,255,.92)" : "rgba(43,43,43,.92)";
    };

    const hexToRgba = (hex, a) => {
      const { r, g, b } = hexToRgb(hex);
      return `rgba(${r},${g},${b},${a})`;
    };

    const setBoardImage = (dataUrlOrNull) => {
      document.documentElement.style.setProperty("--board-image", dataUrlOrNull ? `url("${dataUrlOrNull}")` : "none");
    };

    const applyBoardTint = (colorHex, strengthPct) => {
      const strength = Number(strengthPct) / 100;
      document.documentElement.style.setProperty("--board-tint", colorHex);
      document.documentElement.style.setProperty("--board-tint-a", String(strength));

      els.bgDot.style.background = colorHex;
      els.bgDot.style.boxShadow = `0 0 0 6px ${hexToRgba(colorHex, Math.min(0.35, strength + 0.1))}`;

      els.boardTint.style.background = hexToRgba(colorHex, strength);
    };

    const fileToDataUrl = (file) =>
      new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });

    const applyBgFromStore = () => {
      const bg = loadBg();
      const tint = bg?.tint ?? "#efe7e1";
      const strength = bg?.strength ?? 35;
      els.bgColor.value = tint;
      els.bgStrength.value = String(strength);
      applyBoardTint(tint, strength);
      setBoardImage(bg?.imageDataUrl ?? null);
    };

    // Build timetable DOM
    const renderTimetable = (filtered) => {
      const startMin = state.startHour * 60;
      const endMin = state.endHour * 60;
      const totalMin = Math.max(60, endMin - startMin);

      const pxPerMin = 1.2;
      const bodyHeight = Math.max(420, Math.round(totalMin * pxPerMin));

      const headerHtml = `
        <div class="ttHeader">
          <div class="corner">time</div>
          ${DAY_NAMES.map(d => `<div class="dayName">${d}</div>`).join("")}
        </div>
      `;

      const bodyHtml = `
        <div class="ttBody" id="ttBody" style="height:${bodyHeight}px">
          <div class="timeCol" id="timeCol"></div>
          ${DAY_NAMES.map((_,i)=>`<div class="dayCol" data-day="${i}" id="day_${i}"></div>`).join("")}
        </div>
      `;

      els.panelBody.innerHTML = `
        <div class="gridWrap">
          <div class="timetable">
            ${headerHtml}
            ${bodyHtml}
          </div>
        </div>
      `;

      const timeCol = document.getElementById("timeCol");

      for (let t=startMin; t<=endMin; t+=30){
        const y = ((t - startMin) / totalMin) * bodyHeight;
        const line = document.createElement("div");
        line.className = "hLine" + ((t % 60 === 0) ? " major" : "");
        line.style.top = `${y}px`;
        timeCol.appendChild(line);

        if (t % 60 === 0){
          const lbl = document.createElement("div");
          lbl.className = "timeLabel";
          lbl.style.top = `${y}px`;
          lbl.textContent = minutesToLabel(t);
          timeCol.appendChild(lbl);
        }
      }

      for (let i=0; i<7; i++){
        const col = document.getElementById(`day_${i}`);
        for (let t=startMin; t<=endMin; t+=30){
          const y = ((t - startMin) / totalMin) * bodyHeight;
          const line = document.createElement("div");
          line.className = "hLine" + ((t % 60 === 0) ? " major" : "");
          line.style.top = `${y}px`;
          col.appendChild(line);
        }
      }

      filtered.forEach((it) => {
        const s = timeToMinutes(it.start);
        const e = timeToMinutes(it.end);
        if (s == null || e == null) return;
        if (!withinRange(s,e)) return;

        const col = document.getElementById(`day_${it.day}`);
        if (!col) return;

        const top = ((clampNum(s, startMin, endMin) - startMin) / totalMin) * bodyHeight;
        const bottom = ((clampNum(e, startMin, endMin) - startMin) / totalMin) * bodyHeight;
        const height = Math.max(34, bottom - top);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "event";
        btn.style.top = `${top + 6}px`;
        btn.style.height = `${height - 12}px`;
        btn.setAttribute("aria-label", `${it.title} ${it.start} to ${it.end}`);

        const base = normalizeHex(it.color || "#ffffff");
        btn.style.background = mixWithWhite(base, 0.68);
        btn.style.borderColor = "rgba(43,43,43,.12)";
        btn.style.color = contrastInk(base);

        btn.innerHTML = `
          <div class="eventTitle">${escapeHtml(it.title)}</div>
          <div class="eventMeta">
            <span class="tinyPill">${escapeHtml(it.start)}–${escapeHtml(it.end)}</span>
            ${it.location ? `<span class="tinyPill">${escapeHtml(it.location)}</span>` : ""}
            ${(it.tags || []).slice(0,2).map(t => `<span class="tinyPill">${escapeHtml(t)}</span>`).join("")}
          </div>
          ${it.notes ? `<div class="eventNotes">${escapeHtml(it.notes)}</div>` : ""}
        `;

        btn.addEventListener("click", () => openEditModal(it.id));
        col.appendChild(btn);
      });

      const now = new Date();
      const jsDay = now.getDay(); // Sun=0 ... Sat=6
      const dayIndex = (jsDay + 6) % 7; // Mon=0 ... Sun=6
      const nowMin = now.getHours()*60 + now.getMinutes();

      if (nowMin >= startMin && nowMin <= endMin){
        const y = ((nowMin - startMin) / totalMin) * bodyHeight;
        const body = document.getElementById("ttBody");

        const line = document.createElement("div");
        line.className = "nowLine";
        line.style.top = `${y}px`;

        const dot = document.createElement("div");
        dot.className = "nowDot";
        dot.style.top = `${y}px`;

        body.appendChild(line);
        dot.style.left = `${78 + (dayIndex * ((body.clientWidth - 78) / 7))}px`;
        body.appendChild(dot);
      }
    };

    const renderEmpty = () => {
      els.panelBody.innerHTML = `
        <div class="empty">
          <div class="big" aria-hidden="true">▦</div>
          <h2>No blocks yet</h2>
          <button class="btn primary" type="button" id="emptyAddBtn">＋ Add your first block</button>
        </div>
      `;
      document.getElementById("emptyAddBtn").addEventListener("click", openAddModal);
    };

    const render = () => {
      buildTagOptions(items);
      const filtered = applyFilters();

      els.countPill.textContent = `${items.length} block${items.length === 1 ? "" : "s"}`;

      const parts = [];
      if (state.q) parts.push(`Search: “${state.q}”`);
      if (state.tag) parts.push(`Tag: ${state.tag}`);
      parts.push(`${state.startHour}:00–${state.endHour}:00`);
      els.filteredMeta.textContent = `${filtered.length} shown · ` + parts.join(" · ");

      if (items.length === 0){
        renderEmpty();
        return;
      }

      renderTimetable(filtered);
    };

    // -------- CRUD --------
    const upsert = (payload) => {
      const idx = items.findIndex(x => x.id === payload.id);
      if (idx >= 0) items[idx] = payload;
      else items.unshift(payload);
      save(items);
      render();
    };

    const clearAll = async () => {
      if (!items.length) return;
      const ok = await askConfirm("Clear all blocks? This cannot be undone.", { okText: "Yes, clear", danger: true });
      if (!ok) return;
      items = [];
      save(items);
      render();
    };

    const exportJson = () => {
      const data = JSON.stringify(items, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "weekly-timetable.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // -------- Modal --------
    let lastFocusEl = null;

    const openModal = () => {
      lastFocusEl = document.activeElement;
      els.modalBackdrop.classList.add("show");
      setTimeout(() => els.bTitle.focus(), 0);
      document.addEventListener("keydown", onModalKeydown);
    };

    const closeModal = () => {
      els.modalBackdrop.classList.remove("show");
      document.removeEventListener("keydown", onModalKeydown);
      if (lastFocusEl && typeof lastFocusEl.focus === "function") lastFocusEl.focus();
      resetForm();
    };

    const onModalKeydown = (e) => {
      if (e.key === "Escape") closeModal();

      if (e.key === "Tab"){
        const focusables = els.modalBackdrop.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const list = [...focusables].filter(x => !x.disabled && x.offsetParent !== null);
        if (!list.length) return;

        const first = list[0];
        const last = list[list.length - 1];

        if (e.shiftKey && document.activeElement === first){
          e.preventDefault(); last.focus();
        } else if (!e.shiftKey && document.activeElement === last){
          e.preventDefault(); first.focus();
        }
      }
    };

    const resetForm = () => {
      els.editId.value = "";
      els.modalTitle.textContent = "Add block";
      els.saveBtn.textContent = "Save";

      els.bTitle.value = "";
      els.bDay.value = "0";
      els.bStart.value = "09:00";
      els.bEnd.value = "10:00";
      els.bLocation.value = "";
      els.bTags.value = "";
      els.bNotes.value = "";

      els.bColor.value = "#ffffff";
    };

    const openAddModal = () => {
      resetForm();
      openModal();
    };

    const openEditModal = (id) => {
      const it = items.find(x => x.id === id);
      if (!it) return;

      els.editId.value = it.id;
      els.modalTitle.textContent = "Edit block";
      els.saveBtn.textContent = "Update";

      els.bTitle.value = it.title || "";
      els.bDay.value = String(it.day ?? 0);
      els.bStart.value = it.start || "09:00";
      els.bEnd.value = it.end || "10:00";
      els.bLocation.value = it.location || "";
      els.bTags.value = (it.tags || []).join(", ");
      els.bNotes.value = it.notes || "";

      els.bColor.value = normalizeHex(it.color || "#ffffff");

      openModal();
    };

    // -------- Background controls --------
    els.bgBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (els.themePanel) els.themePanel.classList.remove("open");
      els.bgPanel.classList.toggle("open");
    });

    // -------- Theme controls --------
    els.themeBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (els.bgPanel) els.bgPanel.classList.remove("open");
      els.themePanel.classList.toggle("open");
    });

    // close popovers on outside click
    document.addEventListener("click", (e) => {
      const bgOpen = els.bgPanel.classList.contains("open");
      const thOpen = els.themePanel.classList.contains("open");
      if (!bgOpen && !thOpen) return;

      if (bgOpen && !els.bgPopover.contains(e.target)) els.bgPanel.classList.remove("open");
      if (thOpen && !els.themePopover.contains(e.target)) els.themePanel.classList.remove("open");
    });

    els.bgColor.addEventListener("input", () => {
      applyBoardTint(els.bgColor.value, els.bgStrength.value);
      const bg = loadBg() || {};
      bg.tint = els.bgColor.value;
      bg.strength = Number(els.bgStrength.value);
      saveBg(bg);
    });

    els.bgStrength.addEventListener("input", () => {
      applyBoardTint(els.bgColor.value, els.bgStrength.value);
      const bg = loadBg() || {};
      bg.tint = els.bgColor.value;
      bg.strength = Number(els.bgStrength.value);
      saveBg(bg);
    });

    els.bgImage.addEventListener("change", async () => {
      const file = els.bgImage.files && els.bgImage.files[0];
      if (!file) return;
      const dataUrl = await fileToDataUrl(file);
      setBoardImage(dataUrl);

      const bg = loadBg() || {};
      bg.imageDataUrl = dataUrl;
      bg.tint = els.bgColor.value;
      bg.strength = Number(els.bgStrength.value);
      saveBg(bg);
    });

    els.removeImage.addEventListener("click", () => {
      setBoardImage(null);
      els.bgImage.value = "";
      const bg = loadBg() || {};
      bg.imageDataUrl = null;
      bg.tint = els.bgColor.value;
      bg.strength = Number(els.bgStrength.value);
      saveBg(bg);
    });

    // -------- Events --------
    els.addBtn.addEventListener("click", openAddModal);
    els.exportBtn.addEventListener("click", exportJson);
    els.clearBtn.addEventListener("click", clearAll);

    els.closeModalBtn.addEventListener("click", closeModal);
    els.cancelBtn.addEventListener("click", closeModal);
    els.modalBackdrop.addEventListener("click", (e) => {
      if (e.target === els.modalBackdrop) closeModal();
    });

    els.blockForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = els.bTitle.value.trim();
      const day = Number(els.bDay.value);
      const start = els.bStart.value;
      const end = els.bEnd.value;

      const s = timeToMinutes(start);
      const ee = timeToMinutes(end);

      if (!title || !Number.isFinite(day) || !start || !end) return;
      if (s == null || ee == null || ee <= s){
        await askConfirm("End time must be after start time.", { okText: "OK", cancelText: "Close" });
        return;
      }

      const location = els.bLocation.value.trim();
      const tags = normalizeTags(els.bTags.value);
      const notes = els.bNotes.value.trim();

      const color = normalizeHex(els.bColor.value);

      const id = els.editId.value || crypto.randomUUID();
      const existing = items.find(x => x.id === id);

      const payload = {
        id,
        title,
        day,
        dayName: DAY_NAMES[day],
        start,
        end,
        location,
        tags,
        notes,
        color,
        createdAt: existing ? existing.createdAt : nowISO(),
        updatedAt: nowISO(),
      };

      upsert(payload);
      closeModal();
    });

    els.search.addEventListener("input", () => { state.q = els.search.value; render(); });
    els.tagFilter.addEventListener("change", () => { state.tag = els.tagFilter.value; render(); });

    els.startHour.addEventListener("change", () => {
      const v = Number(els.startHour.value);
      state.startHour = Number.isFinite(v) ? v : 8;
      if (state.endHour <= state.startHour) {
        state.endHour = Math.min(24, state.startHour + 8);
        els.endHour.value = String(state.endHour);
      }
      render();
    });

    els.endHour.addEventListener("change", () => {
      const v = Number(els.endHour.value);
      state.endHour = Number.isFinite(v) ? v : 20;
      if (state.endHour <= state.startHour) {
        state.startHour = Math.max(0, state.endHour - 8);
        els.startHour.value = String(state.startHour);
      }
      render();
    });

    document.addEventListener("keydown", (e) => {
      if (els.modalBackdrop.classList.contains("show")) return;
      if (e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey){
        const a = document.activeElement;
        const typing = a && (a.tagName === "INPUT" || a.tagName === "TEXTAREA" || a.isContentEditable);
        if (!typing){
          e.preventDefault();
          els.search.focus();
        }
      }
    });

    // init theme + bg
    initTheme();
    applyBgFromStore();
    render();

    window.addEventListener("resize", () => {
      clearTimeout(window.__wt_resize);
      window.__wt_resize = setTimeout(render, 120);
    });
  </script>
</body>
</html>
